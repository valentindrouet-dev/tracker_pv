<!doctype html>
<html lang="fr">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>PV – Tableau En Temps Réel</title>
    <meta name="description" content="Tableau des points de vie en temps réel avec édition et mode plein écran." />
    <!-- Tailwind Play CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
      html, body { background: #0b0b0b; }
      /* Smooth font rendering */
      body { -webkit-font-smoothing: antialiased; -moz-osx-font-smoothing: grayscale; }
      /* Small helper for <kbd> */
      kbd { background: rgba(255,255,255,.08); border: 1px solid rgba(255,255,255,.12); border-radius: .375rem; padding: .1rem .35rem; }
    </style>
  </head>
  <body class="text-zinc-100">
    <div id="root"></div>

    <!-- React 18 UMD -->
    <script src="https://unpkg.com/react@18/umd/react.production.min.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js" crossorigin></script>

    <!-- Framer Motion UMD -->
    <script src="https://unpkg.com/framer-motion@10.18.0/dist/framer-motion.umd.js"></script>

    <!-- Babel Standalone for in-browser JSX transform -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <script type="text/babel">
      const { useState, useMemo, useEffect, useRef } = React;
      const { motion, AnimatePresence } = window.framerMotion || {};

      // Polyfill UUID if needed
      const uuid = () => {
        if (window.crypto && crypto.randomUUID) return crypto.randomUUID();
        return "id_" + Math.random().toString(36).slice(2);
      };

      // --- Helpers ---------------------------------------------------------------
      const defaultPlayers = [
        { id: uuid(), name: "Alchimiste",  hp: 32, max: 50, color: "#4a6edb", statuses: [] },
        { id: uuid(), name: "Destructeur", hp: 48, max: 50, color: "#c13b3b", statuses: [] },
        { id: uuid(), name: "Pyromane",    hp: 20, max: 50, color: "#e6a500", statuses: [] },
        { id: uuid(), name: "Déviant",     hp: 24, max: 50, color: "#c07ce6", statuses: [] },
        { id: uuid(), name: "Lamevent",    hp: 28, max: 50, color: "#60a853", statuses: [] },
      ];

      const STORAGE_KEY = "pv-tracker-v1";

      function loadState() {
        try {
          const raw = localStorage.getItem(STORAGE_KEY);
          if (!raw) return defaultPlayers;
          const data = JSON.parse(raw);
          if (!Array.isArray(data)) return defaultPlayers;
          return data.map((p) => {
            const statuses = Array.isArray(p.statuses) ? p.statuses : (p.status ? [p.status] : []);
            const { status, ...rest } = p;
            return { statuses, ...rest };
          });
        } catch {
          return defaultPlayers;
        }
      }

      function saveState(players) {
        try { localStorage.setItem(STORAGE_KEY, JSON.stringify(players)); } catch {}
      }

      // Sort comparators
      const byName   = (a, b) => a.name.localeCompare(b.name);
      const byHpDesc = (a, b) => Number(b.hp) - Number(a.hp);
      const byHpAsc  = (a, b) => Number(a.hp) - Number(b.hp);

      // Status → colors (using your latest mapping)
      const STATUS_COLORS = {
        affaibli: "#64748b", // ardoise (ex Au Sol)
        ausol:    "#8b5e3c", // brun
        feu:      "#ef4444", // rouge vif
      };
      const STATUS_KEYS = ["affaibli", "ausol", "feu"];

      function getGradientForStatuses(statuses, fallback) {
        const active = STATUS_KEYS.filter((k) => statuses?.includes(k));
        if (!active.length) return \`linear-gradient(90deg, \${fallback}, #29d17b)\`;
        const colors = active.map((k) => STATUS_COLORS[k]);
        if (colors.length === 1) return \`linear-gradient(90deg, \${colors[0]}, \${colors[0]})\`;
        const stops = colors.map((c, i) => \`\${c} \${Math.round((i * 100) / (colors.length - 1))}%\`);
        return \`linear-gradient(90deg, \${stops.join(", ")})\`;
      }

      function isLight(hex) {
        const c = hex.replace("#", "");
        const r = parseInt(c.substring(0, 2), 16);
        const g = parseInt(c.substring(2, 4), 16);
        const b = parseInt(c.substring(4, 6), 16);
        const l = 0.2126 * r + 0.7152 * g + 0.0722 * b;
        return l > 160;
      }

      // --- Small UI helpers ------------------------------------------------------
      function Card({ children }) {
        return <div className="rounded-2xl bg-zinc-900/60 border border-zinc-800 p-4 shadow-lg">{children}</div>;
      }

      function NumInput({ label, value, onChange, min = 0 }) {
        return (
          <label className="inline-flex items-center gap-2 px-2 py-1 bg-zinc-800 rounded-xl border border-zinc-700">
            <span className="text-xs text-zinc-400">{label}</span>
            <input
              type="number"
              className="w-20 bg-transparent focus:outline-none text-zinc-100"
              value={value}
              min={min}
              onChange={(e) => onChange(Number(e.target.value))}
            />
          </label>
        );
      }

      function StateButton({ active, onClick, label, style }) {
        return (
          <button
            onClick={onClick}
            style={style}
            className={\`text-xs px-2 py-1 rounded-lg border \${ active ? "shadow-inner" : "bg-zinc-900 border-zinc-700 text-zinc-300 hover:bg-zinc-800" }\`}
            title={label}
          >
            {label}
          </button>
        );
      }

      // --- Main App --------------------------------------------------------------
      function App() {
        const [players, setPlayers] = useState(loadState);
        const [themeAccent, setThemeAccent] = useState("#63ff8b");
        const [flash, setFlash] = useState({});
        const [sortMode, setSortMode] = useState("none"); // none | name | hpdesc | hpasc
        const [isFullscreen, setIsFullscreen] = useState(false);
        const fullscreenRef = useRef(null);

        useEffect(() => saveState(players), [players]);

        // Hotkeys: F (toggle), Esc (exit)
        useEffect(() => {
          const onKey = (e) => {
            const k = (e.key || "").toLowerCase();
            if (k === "f") toggleFullscreen();
            if (e.key === "Escape" && isFullscreen) exitFullscreen();
          };
          window.addEventListener("keydown", onKey);
          return () => window.removeEventListener("keydown", onKey);
        }, [isFullscreen]);

        // Sync with native fullscreen
        useEffect(() => {
          const handler = () => {
            if (!document.fullscreenElement && isFullscreen) setIsFullscreen(false);
          };
          document.addEventListener("fullscreenchange", handler);
          return () => document.removeEventListener("fullscreenchange", handler);
        }, [isFullscreen]);

        const totalMax = useMemo(() => players.reduce((s, p) => s + (Number(p.max) || 0), 0), [players]);
        const totalHP  = useMemo(() => players.reduce((s, p) => s + Math.max(0, Math.min(Number(p.hp) || 0, Number(p.max) || 0)), 0), [players]);

        const triggerFlash = (id, dir) => {
          const token = Date.now() + Math.random();
          setFlash((prev) => ({ ...prev, [id]: { dir, token } }));
          setTimeout(() => setFlash((prev) => ({ ...prev, [id]: null })), 240);
        };

        const addPlayer = () => {
          setPlayers((p) => [...p, { id: uuid(), name: "Nouveau", hp: 10, max: 20, color: "#9ca3af", statuses: [] }]);
        };

        const removePlayer = (id) => setPlayers((p) => p.filter((x) => x.id !== id));

        const update = (id, patch) => setPlayers((prev) => prev.map((pl) => (pl.id === id ? { ...pl, ...patch } : pl)));

        const changeHP = (id, delta) => {
          setPlayers((prev) =>
            prev.map((pl) => {
              if (pl.id !== id) return pl;
              const next = Math.max(0, Math.min(pl.max, (Number(pl.hp) || 0) + delta));
              return { ...pl, hp: next };
            })
          );
          if (delta !== 0) triggerFlash(id, delta > 0 ? "up" : "down");
        };

        const changeHPAbsolute = (id, value, currentHp, max) => {
          const clamped = Math.max(0, Math.min(max, value));
          update(id, { hp: clamped });
          const diff = clamped - (Number(currentHp) || 0);
          if (diff) triggerFlash(id, diff > 0 ? "up" : "down");
        };

        const resetAll = () => setPlayers(defaultPlayers);

        // Display-only sorting (edition order preserved)
        const displayPlayers = useMemo(() => {
          const arr = [...players];
          switch (sortMode) {
            case "name":   return arr.sort(byName);
            case "hpdesc": return arr.sort(byHpDesc);
            case "hpasc":  return arr.sort(byHpAsc);
            default:       return arr;
          }
        }, [players, sortMode]);

        const toggleStatus = (id, statusKey) => {
          setPlayers((prev) =>
            prev.map((pl) => {
              if (pl.id !== id) return pl;
              const set = new Set(pl.statuses || []);
              if (set.has(statusKey)) set.delete(statusKey);
              else set.add(statusKey);
              return { ...pl, statuses: Array.from(set) };
            })
          );
        };

        // Fullscreen helpers
        const requestNativeFullscreen = async () => {
          try {
            const el = fullscreenRef.current || document.documentElement;
            if (el.requestFullscreen) await el.requestFullscreen();
          } catch {}
        };
        const exitNativeFullscreen = async () => {
          try {
            if (document.fullscreenElement && document.exitFullscreen) await document.exitFullscreen();
          } catch {}
        };
        const enterFullscreen = async () => { setIsFullscreen(true); await requestNativeFullscreen(); };
        const exitFullscreen  = async () => { setIsFullscreen(false); await exitNativeFullscreen(); };
        const toggleFullscreen = async () => { if (isFullscreen) await exitFullscreen(); else await enterFullscreen(); };

        return (
          <div className="min-h-screen w-full bg-[#0b0b0b] text-zinc-100 p-6">
            <div className="max-w-5xl mx-auto" ref={fullscreenRef}>
              <h1 className="text-3xl md:text-4xl font-extrabold tracking-tight drop-shadow mb-6">Tableau des Points de Vie</h1>

              {/* --- AFFICHAGE --- */}
              <div className="bg-zinc-900/60 p-4 rounded-2xl shadow-lg border border-zinc-800 space-y-3 mb-2 relative">
                <div className="absolute right-4 top-4 flex gap-2">
                  <button
                    onClick={toggleFullscreen}
                    className="px-3 py-1 rounded-xl bg-zinc-800 hover:bg-zinc-700 border border-zinc-600 text-sm"
                    title="Basculer en plein écran (F)"
                  >
                    {isFullscreen ? "Quitter le plein écran" : "Plein écran"}
                  </button>
                </div>

                {displayPlayers.map((p) => {
                  const max = Number(p.max) > 0 ? Number(p.max) : 1;
                  const clamped = Math.max(0, Math.min(Number(p.hp) || 0, max));
                  const percent = Math.round((clamped / max) * 100);
                  const bg = p.statuses && p.statuses.length
                    ? getGradientForStatuses(p.statuses, themeAccent)
                    : \`linear-gradient(90deg, \${themeAccent}, #29d17b)\`;
                  const f = flash[p.id];
                  return (
                    <div key={p.id}>
                      <div className="flex items-center justify-between mb-1">
                        <div className="text-2xl font-extrabold tracking-wide drop-shadow" style={{ color: p.color }}>
                          {p.name}
                        </div>
                        <div className="text-sm text-zinc-400">{percent}%</div>
                      </div>
                      <div className="relative w-full h-10 rounded-xl overflow-hidden bg-zinc-800 border border-emerald-500/20 shadow-inner">
                        {motion ? (
                          <motion.div
                            initial={{ width: 0 }}
                            animate={{ width: \`\${percent}%\` }}
                            transition={{ type: "spring", stiffness: 120, damping: 18 }}
                            className="h-full flex items-center justify-center font-extrabold text-sm md:text-base"
                            style={{ background: bg, color: "#004d26", textShadow: "0 0 2px rgba(0,0,0,0.4)" }}
                          >
                            {clamped}
                          </motion.div>
                        ) : (
                          <div className="h-full flex items-center justify-center font-extrabold text-sm md:text-base transition-all" style={{ width: \`\${percent}%\`, background: bg, color: "#004d26", textShadow: "0 0 2px rgba(0,0,0,0.4)" }}>
                            {clamped}
                          </div>
                        )}
                        {AnimatePresence && f && (
                          <AnimatePresence>
                            <motion.div
                              key={f.token}
                              className="absolute inset-0 pointer-events-none rounded-xl"
                              style={{ backgroundColor: f.dir === "up" ? "rgba(34,197,94,0.25)" : "rgba(239,68,68,0.25)" }}
                              initial={{ opacity: 0.25 }}
                              animate={{ opacity: 0 }}
                              exit={{ opacity: 0 }}
                              transition={{ duration: 0.25 }}
                            />
                          </AnimatePresence>
                        )}
                        <div
                          className="absolute inset-0 pointer-events-none opacity-20"
                          style={{
                            backgroundImage:
                              "linear-gradient(45deg,transparent 25%,rgba(255,255,255,.3) 25%,rgba(255,255,255,.3) 50%,transparent 50%,transparent 75%,rgba(255,255,255,.3) 75%,rgba(255,255,255,.3))",
                            backgroundSize: "20px 20px",
                          }}
                        />
                      </div>
                    </div>
                  );
                })}
                <div className="flex justify-end gap-2 pt-3">
                  <button onClick={() => setSortMode("name")}   className="px-3 py-1 rounded-xl bg-zinc-800 hover:bg-zinc-700 border border-zinc-600 text-sm">Noms</button>
                  <button onClick={() => setSortMode("hpdesc")} className="px-3 py-1 rounded-xl bg-zinc-800 hover:bg-zinc-700 border border-zinc-600 text-sm">PV Max</button>
                  <button onClick={() => setSortMode("hpasc")}  className="px-3 py-1 rounded-xl bg-zinc-800 hover:bg-zinc-700 border border-zinc-600 text-sm">PV Min</button>
                </div>
              </div>

              {/* --- ÉDITION --- */}
              <h2 className="text-xl font-bold text-zinc-300 mb-3">Édition</h2>
              <div className="space-y-4 mb-8">
                {players.map((p) => (
                  <div key={p.id} className="flex flex-col md:flex-row md:items-center gap-3 bg-zinc-900/60 p-4 rounded-2xl shadow-lg border border-zinc-800">
                    <div className="flex flex-col md:flex-row md:items-center md:gap-4 flex-1">
                      <input
                        value={p.name}
                        onChange={(e) => update(p.id, { name: e.target.value })}
                        className="w-full md:w-64 px-3 py-2 rounded-xl bg-zinc-800 border border-zinc-700 focus:outline-none focus:ring-2 focus:ring-emerald-400/40 text-lg font-bold"
                        placeholder="Nom du joueur"
                      />
                      <div className="flex items-center gap-2 mt-2 md:mt-0">
                        <NumInput label="PV" value={p.hp} onChange={(v) => changeHPAbsolute(p.id, v, p.hp, p.max)} />
                        <span className="text-zinc-500">/</span>
                        <NumInput label="Max" value={p.max} min={1} onChange={(v) => update(p.id, { max: v, hp: Math.min(p.hp, v) })} />
                      </div>
                      <div className="mt-2 md:mt-0 flex gap-2">
                        {STATUS_KEYS.map((key) => {
                          const active = p.statuses?.includes(key);
                          const c = STATUS_COLORS[key];
                          const style = active ? { backgroundColor: c, borderColor: c, color: isLight(c) ? "#111" : "#fff" } : {};
                          const label = key === "affaibli" ? "Affaibli" : key === "ausol" ? "Au Sol" : "Feu";
                          return (
                            <StateButton
                              key={key}
                              active={active}
                              onClick={() => toggleStatus(p.id, key)}
                              label={label}
                              style={style}
                            />
                          );
                        })}
                      </div>
                    </div>

                    <div className="flex flex-col gap-1">
                      <div className="flex gap-1">
                        {[-5, -1, +1, +5].map((delta) => (
                          <button
                            key={delta}
                            onClick={() => changeHP(p.id, delta)}
                            className={\`px-2 py-1 text-xs rounded-lg border \${ delta < 0 ? "bg-red-900/40 hover:bg-red-900/60 border-red-800 text-red-200" : "bg-green-900/40 hover:bg-green-900/60 border-green-800 text-green-200" }\`}
                          >
                            {delta > 0 ? \`+\${delta}\` : delta}
                          </button>
                        ))}
                      </div>
                    </div>

                    <div className="flex items-center gap-2">
                      <input
                        type="color"
                        value={p.color}
                        onChange={(e) => update(p.id, { color: e.target.value })}
                        className="w-10 h-10 rounded-md bg-zinc-900 border border-zinc-700"
                        title="Couleur du nom"
                      />
                      <button
                        onClick={() => removePlayer(p.id)}
                        className="ml-auto px-3 py-2 rounded-xl bg-red-900/40 hover:bg-red-900/60 border border-red-800 text-red-200"
                        title="Supprimer ce joueur"
                      >
                        Supprimer
                      </button>
                    </div>
                  </div>
                ))}
              </div>

              {/* --- Options bas de page --- */}
              <div className="mb-6 grid grid-cols-1 md:grid-cols-4 gap-3 mt-6">
                <Card>
                  <div className="text-sm text-zinc-400 mb-2">Couleur de barre</div>
                  <input
                    type="color"
                    value={themeAccent}
                    onChange={(e) => setThemeAccent(e.target.value)}
                    className="w-full h-10 rounded-md bg-zinc-900 border border-zinc-700"
                    title="Couleur principale des barres de PV"
                  />
                </Card>
                <Card>
                  <div className="text-zinc-400 text-sm">PV actuels</div>
                  <div className="text-2xl font-bold">{totalHP}</div>
                </Card>
                <Card>
                  <div className="text-zinc-400 text-sm">PV max</div>
                  <div className="text-2xl font-bold">{totalMax}</div>
                </Card>
                <Card>
                  <div className="text-zinc-400 text-sm">% global</div>
                  <div className="text-2xl font-bold">{totalMax ? Math.round((totalHP / totalMax) * 100) : 0}%</div>
                </Card>
              </div>

              <div className="flex items-center gap-2 mb-6">
                <button
                  onClick={addPlayer}
                  className="px-3 py-2 rounded-2xl bg-zinc-800 hover:bg-zinc-700 transition shadow-md"
                  title="Ajouter un joueur"
                >
                  Ajouter
                </button>
                <button
                  onClick={() => saveState(players)}
                  className="px-3 py-2 rounded-2xl bg-zinc-800 hover:bg-zinc-700 transition shadow-md"
                  title="Sauvegarder dans le navigateur"
                >
                  Sauver
                </button>
                <button
                  onClick={resetAll}
                  className="px-3 py-2 rounded-2xl bg-zinc-800 hover:bg-zinc-700 transition shadow-md"
                  title="Revenir aux valeurs d'exemple"
                >
                  Réinitialiser
                </button>
              </div>

              <p className="mt-6 text-xs text-zinc-500">
                Astuce : Raccourcis → <kbd>F</kbd> plein écran, <kbd>Échap</kbd> quitter. Les données sont stockées en local (localStorage).
              </p>
            </div>

            {/* OVERLAY PLEIN ÉCRAN */}
            <AnimatePresence>
              {isFullscreen && (
                <motion.div
                  key="fs"
                  initial={{ opacity: 0 }}
                  animate={{ opacity: 1 }}
                  exit={{ opacity: 0 }}
                  transition={{ duration: 0.2 }}
                  className="fixed inset-0 z-50 bg-black/90"
                >
                  <div className="absolute top-4 right-4 flex gap-2">
                    <button
                      onClick={toggleFullscreen}
                      className="px-4 py-2 rounded-xl bg-zinc-800 hover:bg-zinc-700 border border-zinc-600 text-sm"
                    >
                      Quitter le plein écran
                    </button>
                  </div>

                  <div className="max-w-6xl mx-auto pt-16 px-6 space-y-6">
                    {displayPlayers.map((p) => {
                      const max = Number(p.max) > 0 ? Number(p.max) : 1;
                      const clamped = Math.max(0, Math.min(Number(p.hp) || 0, max));
                      const percent = Math.round((clamped / max) * 100);
                      const bg = p.statuses && p.statuses.length
                        ? getGradientForStatuses(p.statuses, themeAccent)
                        : \`linear-gradient(90deg, \${themeAccent}, #29d17b)\`;
                      const f = flash[p.id];
                      return (
                        <div key={p.id}>
                          <div className="flex items-center justify-between mb-2">
                            <div className="text-3xl md:text-4xl font-extrabold tracking-wide drop-shadow" style={{ color: p.color }}>
                              {p.name}
                            </div>
                            <div className="text-lg text-zinc-300">{percent}%</div>
                          </div>
                          <div className="relative w-full h-16 rounded-2xl overflow-hidden bg-zinc-800 border border-emerald-500/30 shadow-inner">
                            {motion ? (
                              <motion.div
                                initial={{ width: 0 }}
                                animate={{ width: \`\${percent}%\` }}
                                transition={{ type: "spring", stiffness: 120, damping: 18 }}
                                className="h-full flex items-center justify-center font-extrabold text-xl"
                                style={{ background: bg, color: "#00331a", textShadow: "0 0 2px rgba(0,0,0,0.5)" }}
                              >
                                {clamped}
                              </motion.div>
                            ) : (
                              <div className="h-full flex items-center justify-center font-extrabold text-xl transition-all" style={{ width: \`\${percent}%\`, background: bg, color: "#00331a", textShadow: "0 0 2px rgba(0,0,0,0.5)" }}>
                                {clamped}
                              </div>
                            )}
                            {AnimatePresence && f && (
                              <AnimatePresence>
                                <motion.div
                                  key={f.token}
                                  className="absolute inset-0 pointer-events-none rounded-2xl"
                                  style={{ backgroundColor: f.dir === "up" ? "rgba(34,197,94,0.25)" : "rgba(239,68,68,0.25)" }}
                                  initial={{ opacity: 0.25 }}
                                  animate={{ opacity: 0 }}
                                  exit={{ opacity: 0 }}
                                  transition={{ duration: 0.25 }}
                                />
                              </AnimatePresence>
                            )}
                            <div
                              className="absolute inset-0 pointer-events-none opacity-10"
                              style={{
                                backgroundImage:
                                  "linear-gradient(45deg,transparent 25%,rgba(255,255,255,.3) 25%,rgba(255,255,255,.3) 50%,transparent 50%,transparent 75%,rgba(255,255,255,.3) 75%,rgba(255,255,255,.3))",
                                backgroundSize: "28px 28px",
                              }}
                            />
                          </div>
                        </div>
                      );
                    })}

                    <div className="flex justify-end gap-3 pt-2">
                      <button onClick={() => setSortMode("name")}   className="px-4 py-2 rounded-xl bg-zinc-800 hover:bg-zinc-700 border border-zinc-600 text-sm">Noms</button>
                      <button onClick={() => setSortMode("hpdesc")} className="px-4 py-2 rounded-xl bg-zinc-800 hover:bg-zinc-700 border border-zinc-600 text-sm">PV Max</button>
                      <button onClick={() => setSortMode("hpasc")}  className="px-4 py-2 rounded-xl bg-zinc-800 hover:bg-zinc-700 border border-zinc-600 text-sm">PV Min</button>
                    </div>
                  </div>
                </motion.div>
              )}
            </AnimatePresence>
          </div>
        );
      }

      // Render
      const root = ReactDOM.createRoot(document.getElementById("root"));
      root.render(<App />);
    </script>
  </body>
</html>
