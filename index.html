<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
  <title>Tableau des Points de Vie</title>

  <!-- PWA meta -->
  <meta name="theme-color" content="#0a0e1a">
  <link rel="manifest" href="manifest.webmanifest">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="PV Tracker">
  <link rel="apple-touch-icon" href="icons/icon-192.png">

  <style>
    
    

/* --- STEP3: ultra-compact buttons to guarantee single-line fit --- */
.big-keys{
  display:flex;
  flex-wrap:nowrap;
  gap:.2rem;
  align-items:center;
  justify-content:center;
}
.big-keys .key{
  flex:0 0 auto;      /* no growth, no shrink to negative widths */
  min-width:0;        /* allow the smallest width possible */
  padding:.28rem .38rem;
  font-size:.9rem;
  line-height:1;
  border-radius:.5rem;
  white-space:nowrap; /* keep labels intact */
}
.pv-center{
  width:3.5rem;       /* narrower center field */
  padding:.3rem .4rem;
  font-size:.95rem;
}
@media (max-width: 420px){
  .big-keys{ gap:.16rem; }
  .big-keys .key{ padding:.26rem .34rem; font-size:.85rem; }
  .pv-center{ width:3.2rem; font-size:.9rem; }
}

/* --- STEP2: single-row controls between ‚ò†Ô∏è and üíö --- */
.big-keys{
  display:flex;
  flex-wrap:nowrap;   /* force a single line */
  gap:.32rem;
  align-items:center;
  justify-content:center;
}
.big-keys .key{
  padding:.45rem .6rem;
  min-width:auto;
  line-height:1;
  border-radius:.6rem;
}
.pv-center{
  width:4.5rem; /* slightly narrower to help fit one row */
}
@media (max-width: 420px){
  .big-keys .key{ padding:.4rem .5rem; }
  .pv-center{ width:4rem; }
}

/* Center PV input between - and + keys */
    .pv-center{
      width: 5rem;
      text-align: center;
      background: #0f1419;
      color: #e5e7eb;
      border: 1px solid var(--border);
      border-radius: .5rem;
      padding: .4rem .5rem;
    }
    .big-keys{
      display:flex;
      gap:.4rem;
      flex-wrap:wrap;
      align-items:center;
      justify-content:center;
    }

:root {
      --bg: #0a0e1a;
      --panel: rgba(26,31,46,0.9);
      --panel-plain: #1a1f2e;
      --muted: #a1a1aa;
      --border: rgba(71,85,105,0.6);
      --accent: #63ff8b;
    }

    * { box-sizing: border-box; }
    html, body { margin:0; padding:0; height:100%; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
      background: var(--bg);
      color: #f4f4f5;
    }

    .app { max-width: 860px; margin: 0 auto; padding-bottom: env(safe-area-inset-bottom); }

    .topbar { position: sticky; top: 0; z-index: 30; backdrop-filter: saturate(1.2) blur(8px);
      background: linear-gradient(180deg, rgba(10,14,26,0.95), rgba(10,14,26,0.7)); border-bottom: 1px solid var(--border); }
    .topbar-inner { max-width: 860px; margin: 0 auto; padding: .6rem .6rem .45rem; display: flex; gap: .4rem; align-items: center; }
    h1.title { font-size: 1.25rem; font-weight: 800; letter-spacing: -0.02em; margin-right: auto; }
    .tabs { background: var(--panel-plain); border: 1px solid var(--border); border-radius: 9999px; display: inline-flex; padding: .2rem; gap: .2rem; }
    .tab-btn { appearance: none; border: 0; border-radius: 9999px; padding: .4rem .7rem; font-weight: 700; font-size: .9rem; color: #e5e7eb; background: transparent; }
    .tab-btn.active { background: #2563eb; color: white; box-shadow: 0 0 14px rgba(37,99,235,.3); }
    .bar-btn { margin-left: .4rem; padding: .4rem .6rem; border-radius: 12px; background: var(--panel-plain); border: 1px solid var(--border); color: #f4f4f5; font-weight: 600; font-size:.9rem; }

    .section { padding: .6rem; }

    .display-card { background: var(--panel); border: 1px solid var(--border); border-radius: 14px; padding: .6rem; box-shadow: 0 8px 18px rgba(0,0,0,.22); }
    .display-header { display: flex; justify-content: flex-end; gap: .4rem; margin-bottom: .4rem; }
    .btn { padding: .45rem .6rem; border-radius: 10px; border: 1px solid var(--border); background: #121828; color: #f4f4f5; font-size:.95rem; }

    .player-display { margin-bottom: .6rem; }
    .player-header { display:flex; align-items:center; justify-content:space-between; margin-bottom:.2rem;}
    .player-name-display { font-size: 1.2rem; font-weight: 800; letter-spacing: .02em; text-shadow: 0 1px 2px rgba(0,0,0,.3); }
    .player-percent { color: var(--muted); font-size: .9rem; }

    .hp-bar-container { position:relative; width:100%; height:2.4rem; border-radius:.7rem; overflow:hidden; border:1px solid rgba(16,185,129,.25); box-shadow: inset 0 2px 4px rgba(0,0,0,.35); background:#0f1419; }
    .hp-bar { height:100%; display:flex; align-items:center; justify-content:center; font-weight:900; font-size:.95rem; color:#004d26; transition:width .35s cubic-bezier(.4,0,.2,1); position:relative; }
    .hp-bar::after { content:""; position:absolute; inset:0; background-image: linear-gradient(45deg, transparent 25%, rgba(255,255,255,.12) 25%, rgba(255,255,255,.12) 50%, transparent 50%, transparent 75%, rgba(255,255,255,.12) 75%, rgba(255,255,255,.12)); background-size: 16px 16px; opacity:.22; pointer-events:none; }

    .sort-buttons { display:flex; justify-content:flex-end; gap:.4rem; padding-top:.4rem; }
    .btn-sort { padding:.35rem .55rem; border-radius:9px; border:1px solid var(--border); font-size:.9rem; }
    .btn-sort.active { background:#2563eb; color:#fff; border-color:#3b82f6; }

    /* EDIT UI: compact */
    .edit-stack { display: flex; flex-direction: column; gap: .5rem; }
    .edit-card { background: var(--panel); border: 1px solid var(--border); border-radius: 14px; overflow: hidden; }
    .edit-header { display:flex; align-items:center; gap:.45rem; padding:.55rem .6rem; flex-wrap: wrap; }
    .pill { font-size:.7rem; font-weight:800; letter-spacing:.02em; padding:.25rem .45rem; border-radius:9999px; background:#0f1419; border:1px solid var(--border); min-width:38px; text-align:center; }
    .edit-name { flex:1 1 140px; font-size:.95rem; font-weight:800; border:0; background:transparent; color:#f4f4f5; outline:none; min-width: 120px; }
    .badge { font-size:.7rem; padding:.2rem .4rem; border-radius:9999px; border:1px solid var(--border); color:#e5e7eb; background:#0f1419; }

    .inline-field { display:flex; align-items:center; gap:.3rem; background:#0f1419; border:1px solid var(--border); border-radius:9px; padding:.28rem .4rem; min-height:30px; }
    .inline-field label { font-size:.75rem; color:var(--muted); }
    .inline-field input[type="number"] { width:56px; text-align:center; background:transparent; border:0; color:#fff; font-size:.9rem; outline:none; }

    .edit-body { padding:.5rem .6rem .6rem; border-top:1px dashed var(--border); display:grid; grid-template-columns:1fr; gap:.5rem; }
    .big-keys { display:grid; grid-template-columns: repeat(6, 1fr); gap:.4rem; }
    .key { min-height: 36px; border-radius: 10px; font-weight: 900; font-size: .95rem; border: 1px solid var(--border); background: #121828; color: #e5e7eb; padding: .2rem .3rem; }
    .key.neg { background: rgba(127,29,29,.5); color: #fecaca; }
    .key.pos { background: rgba(20,83,45,.5); color: #bbf7d0; }

    .danger-btn { background: rgba(127,29,29,.45); color:#fecaca; border:1px solid #991b1b; padding:.45rem .6rem; border-radius: 10px; font-weight:700; font-size:.9rem; }
    .btn { cursor:pointer; }

    .color-pick { width: 36px; height: 36px; border-radius: 9px; border: 1px solid var(--border); background: #0f1419; }

    .fullscreen { position:fixed; inset:0; z-index:50; background: rgba(0,0,0,.95); padding: 3rem .6rem; display:none; }
    .fullscreen.active { display:block; }
    .fullscreen-close { position:absolute; top:.6rem; right:.6rem; }

    @keyframes flash-up { from { box-shadow: inset 0 0 26px rgba(34,197,94,.45);} to { box-shadow:none;} }
    @keyframes flash-down { from { box-shadow: inset 0 0 26px rgba(239,68,68,.45);} to { box-shadow:none;} }
    .flash-up { animation: flash-up .22s ease-out; }
    .flash-down { animation: flash-down .22s ease-out; }
  
/* === Micro-ajustement PV central (visuel seulement) === */
.edit-card .pv-center {
  height: 36px;
  min-height: 36px;
  line-height: 36px;
  font-weight: 800;
  font-size: 1.05rem;
  text-align: center;
  padding: 0 10px;
  border-radius: .5rem;
  box-sizing: border-box;
  vertical-align: middle;
}


/* UI Reset: remove any accidental extra top padding on edit cards */
.edit-card { padding-top: 0 !important; }


/* UI Fix 6.4: hide PV/PV Max badge in edit mode */
.edit-card .badge { display: none !important; }


20%  { opacity: 1; }
  100% { opacity: 0; }
}


18%  { opacity: 1; }
  100% { opacity: 0; }
}


/* UI 6.6: flash feedback on the button itself */
.edit-card .big-keys .key,
.card .big-keys .key { position: relative; overflow: visible; }

.key.btn-flash-pos::after,
.key.btn-flash-neg::after{
  content:"";
  position:absolute;
  inset:-2px;
  border-radius: inherit;
  pointer-events:none;
  animation: btnFlash 300ms ease-out;
}

.key.btn-flash-pos::after{ box-shadow: 0 0 0 3px rgba(40, 200, 120, 0.55); }
.key.btn-flash-neg::after{ box-shadow: 0 0 0 3px rgba(220, 60, 60, 0.6); }

@keyframes btnFlash {
  0%   { opacity: 0; }
  20%  { opacity: 1; }
  100% { opacity: 0; }
}


/* UI 6.6b: ensure flash applies to ANY .key button, not only inside .big-keys */
.key { position: relative; overflow: visible; }

.key.btn-flash-pos::after,
.key.btn-flash-neg::after{
  content:"";
  position:absolute;
  inset:-3px;
  border-radius: inherit;
  pointer-events:none;
  animation: btnFlash 340ms ease-out;
}
.key.btn-flash-pos::after{ box-shadow: 0 0 0 3px rgba(40, 200, 120, 0.65); }
.key.btn-flash-neg::after{ box-shadow: 0 0 0 3px rgba(220, 60, 60, 0.7); }

@keyframes btnFlash {
  0%   { opacity: 0; transform: scale(1); }
  20%  { opacity: 1; transform: scale(0.98); }
  100% { opacity: 0; transform: scale(1); }
}


/* UI 6.7: DEAD style when HP == 0 */
.hp-bar-container.dead{
  position: relative;
  background: repeating-linear-gradient(
      -45deg,
      rgba(120,0,0,0.35) 0,
      rgba(120,0,0,0.35) 12px,
      rgba(80,0,0,0.35) 12px,
      rgba(80,0,0,0.35) 24px
  ) !important;
  box-shadow: inset 0 0 0 2px rgba(120,0,0,0.35), inset 0 4px 6px rgba(0,0,0,0.45);
}
.hp-bar-container.dead::after{
  content: "‚ò†Ô∏è";
  position:absolute;
  inset: 0;
  display:flex;
  align-items:center;
  justify-content:center;
  font-weight: 800;
  font-size: 1.2rem;
  color: #ff6b6b;
  text-shadow: 0 1px 0 rgba(0,0,0,0.6);
  pointer-events:none;
}
.hp-bar-container.dead .hp-bar{
  background: transparent !important;
  color: transparent !important;
  width: 100% !important;   /* so the capsule keeps same height/rounding */
}


/* UI 6.7b: lighten DEAD bar (more visible, not too vivid) */
.hp-bar-container.dead{
  background: repeating-linear-gradient(
      -45deg,
      rgba(170, 35, 35, 0.28) 0,
      rgba(170, 35, 35, 0.28) 10px,
      rgba(120, 20, 20, 0.20) 10px,
      rgba(120, 20, 20, 0.20) 20px
  ) !important;
  box-shadow:
    inset 0 0 0 2px rgba(190, 90, 90, 0.40),
    inset 0 3px 6px rgba(0,0,0,0.35);
}
.hp-bar-container.dead::after{
  color: #ff8a8a; /* a touch brighter for readability */
  text-shadow: 0 1px 0 rgba(0,0,0,0.55);
}


/* UI 6.7c: dead bar = empty capsule + skull (no red background) */
.hp-bar-container.dead{
  background: #0f1419 !important;            /* back to neutral capsule */
  box-shadow: inset 0 2px 4px rgba(0,0,0,.35) !important;
}
.hp-bar-container.dead::after{
  content: "‚ò†Ô∏è";
  color: #e6e6e6;
  text-shadow: 0 1px 0 rgba(0,0,0,0.55);
}
.hp-bar-container.dead .hp-bar{
  background: transparent !important;
  color: transparent !important;
  width: 0 !important;                        /* truly empty bar */
}

</style>

<style id="ui-step4-compact-override">
/* --- STEP4 OVERRIDE: force ultra-compact single-line controls (wins via !important & specificity) --- */
.edit-card .big-keys{
  display:flex !important;
  flex-wrap:nowrap !important;
  gap:.12rem !important;
  align-items:center !important;
  justify-content:center !important;
}
.edit-card .big-keys .key{
  flex:0 0 auto !important;
  min-width:0 !important;
  padding:.2rem .3rem !important;
  font-size:.78rem !important;
  line-height:1 !important;
  border-radius:.45rem !important;
  white-space:nowrap !important;
}
.edit-card .big-keys .key:has(> svg){ /* in case icons exist later */
  padding:.15rem .26rem !important;
}
.edit-card .pv-center{
  width:3.1rem !important;
  padding:.25rem .35rem !important;
  font-size:.9rem !important;
}
/* Optional: tighten the skull/heart emoji button min-width */
.edit-card .big-keys .key:first-child,
.edit-card .big-keys .key:last-child{
  min-width:1.8rem !important;
  padding:.18rem .26rem !important;
  font-size:.9rem !important; /* keep emoji readable */
}
@media (max-width: 420px){
  .edit-card .big-keys{ gap:.1rem !important; }
  .edit-card .big-keys .key{ font-size:.72rem !important; padding:.18rem .26rem !important; }
  .edit-card .pv-center{ width:2.9rem !important; font-size:.85rem !important; }
}

/* === Micro-ajustement PV central (visuel seulement) === */
.edit-card .pv-center {
  height: 36px;
  min-height: 36px;
  line-height: 36px;
  font-weight: 800;
  font-size: 1.05rem;
  text-align: center;
  padding: 0 10px;
  border-radius: .5rem;
  box-sizing: border-box;
  vertical-align: middle;
}

</style>


<style id="ui-step5-grid-equal-width">
/* --- STEP5: full-width single row, equal button widths, PV slightly wider --- */
.edit-card .big-keys{
  display:grid !important;
  grid-template-columns: repeat(4, 1fr) 1.25fr repeat(4, 1fr) !important;
  gap:.32rem !important;
  align-items:center !important;
  width:100% !important;
}
.edit-card .big-keys .key,
.edit-card .big-keys button{
  width:100% !important;
  min-width:0 !important;
  padding:.4rem .3rem !important;
  font-size:.9rem !important;
  line-height:1.1 !important;
  border-radius:.5rem !important;
  white-space:nowrap !important;
}
.edit-card .big-keys .pv-center{
  width:100% !important;   /* take the full 1.25fr cell */
  padding:.35rem .45rem !important;
  font-size:1rem !important;  /* slightly larger for readability */
  text-align:center !important;
}
@media (max-width: 420px){
  .edit-card .big-keys{ gap:.24rem !important; grid-template-columns: repeat(4, 1fr) 1.2fr repeat(4, 1fr) !important; }
  .edit-card .big-keys .key, .edit-card .big-keys button{ font-size:.85rem !important; padding:.34rem .28rem !important; }
  .edit-card .big-keys .pv-center{ font-size:.95rem !important; }
}

/* === Micro-ajustement PV central (visuel seulement) === */
.edit-card .pv-center {
  height: 36px;
  min-height: 36px;
  line-height: 36px;
  font-weight: 800;
  font-size: 1.05rem;
  text-align: center;
  padding: 0 10px;
  border-radius: .5rem;
  box-sizing: border-box;
  vertical-align: middle;
}

</style>

</head>
<body>
  <div class="topbar">
    <div class="topbar-inner">
      <h1 class="title">Tableau des Points de Vie</h1>
      <div class="tabs">
        <button class="tab-btn active" id="tab-display" onclick="setTab('display')">Affichage</button>
        <button class="tab-btn" id="tab-edit" onclick="setTab('edit')">√âdition</button>
      </div>
      <button class="bar-btn" onclick="toggleFullscreen()">Plein √©cran</button>
    </div>
  </div>

  <div class="app">
    <section id="section-display" class="section">
      <div class="display-card">
        <div id="display-area"></div>
        <div class="sort-buttons">
          <button onclick="sortPlayers('name')" id="sort-name" class="btn-sort">Noms</button>
          <button onclick="sortPlayers('hpdesc')" id="sort-hpdesc" class="btn-sort">PV Max</button>
          <button onclick="sortPlayers('hpasc')" id="sort-hpasc" class="btn-sort">PV Min</button>
        </div>
      </div>
    </section>

    <section id="section-edit" class="section" style="display:none;">
      <div class="edit-stack" id="edit-stack"></div>
      <div style="height:.4rem;"></div>
      <div class="display-card" style="margin-top:.2rem;">
        <div style="display:grid; grid-template-columns: 1fr 1fr; gap:.4rem;">
          <button class="btn" onclick="addPlayer()">+ Ajouter</button>
          <button class="btn" onclick="resetAll()">üîÑ R√©initialiser</button>
        </div>
      </div>
    </section>
  </div>

  <div id="fullscreen" class="fullscreen">
    <button onclick="toggleFullscreen()" class="btn fullscreen-close">Quitter le plein √©cran</button>
    <div id="fullscreen-content" class="fullscreen-content"></div>
  </div>

  <script>
    function setTab(which) {
      const isDisplay = which === 'display';
      document.getElementById('section-display').style.display = isDisplay ? '' : 'none';
      document.getElementById('section-edit').style.display = isDisplay ? 'none' : '';
      document.getElementById('tab-display').classList.toggle('active', isDisplay);
      document.getElementById('tab-edit').classList.toggle('active', !isDisplay);
    }

    const defaultPlayers = [
      { id: 1, name: "Alchimiste", hp: 32, max: 50, color: "#4a6edb" },
      { id: 2, name: "Destructeur", hp: 48, max: 50, color: "#c13b3b" },
      { id: 3, name: "Pyromane", hp: 20, max: 50, color: "#e6a500" },
      { id: 4, name: "D√©viant", hp: 24, max: 50, color: "#c07ce6" },
      { id: 5, name: "Lamevent", hp: 28, max: 50, color: "#60a853" }
    ];

    let players = [];
    let sortMode = 'none';
    let nextId = 6;
    const USE_FIREBASE = true;

    function saveData() { if (!USE_FIREBASE) localStorage.setItem('pv-tracker-v1', JSON.stringify(players)); }
    function loadData() {
      if (!USE_FIREBASE) {
        const saved = localStorage.getItem('pv-tracker-v1');
        if (saved) {
          try { players = JSON.parse(saved); nextId = players.length ? Math.max(...players.map(p => p.id)) + 1 : 1; }
          catch { players = JSON.parse(JSON.stringify(defaultPlayers)); nextId = 6; }
        } else { players = JSON.parse(JSON.stringify(defaultPlayers)); nextId = 6; }
      }
    }

    async function resetAll() {
      if (!USE_FIREBASE) {
        players = JSON.parse(JSON.stringify(defaultPlayers));
        nextId = 6;
        return render();
      }
      try {
        const snap = await playersCol.get();
        const batch1 = db.batch();
        snap.forEach(doc => {
          batch1.set(doc.ref, { __deleted: true, updatedAt: firebase.firestore.FieldValue.serverTimestamp() }, { merge: true });
        });
        await batch1.commit();

        const batch2 = db.batch();
        defaultPlayers.forEach(p => {
          const ref = playersCol.doc(String(p.id));
          batch2.set(ref, { ...p, __deleted: false, updatedAt: firebase.firestore.FieldValue.serverTimestamp() }, { merge: true });
        });
        await batch2.commit();
      } catch (e) {
        console.error('resetAll failed', e);
      }
    }

    function addPlayer() {
      if (!USE_FIREBASE) { players.push({ id: nextId++, name: "Nouveau", hp: 10, max: 20, color: "#9ca3af" }); return render(); }
      const p = { id: nextId++, name: "Nouveau", hp: 10, max: 20, color: "#9ca3af", __deleted: false, updatedAt: firebase.firestore.FieldValue.serverTimestamp() };
      playersCol.doc(String(p.id)).set(p, { merge: true });
    }

    async function removePlayer(id, docId) {
      // UI optimiste
      players = players.filter(p => p.id != id);
      render();

      if (!USE_FIREBASE) return;
      try {
        if (docId) {
          await playersCol.doc(docId).set({ __deleted: true, updatedAt: firebase.firestore.FieldValue.serverTimestamp() }, { merge: true });
          return;
        }
      } catch (e) {
        console.warn('soft delete by docId failed, fallback to query', e);
      }
      try {
        const q = await playersCol.where('id', '==', id).limit(1).get();
        if (!q.empty) {
          await q.docs[0].ref.set({ __deleted: true, updatedAt: firebase.firestore.FieldValue.serverTimestamp() }, { merge: true });
        }
      } catch (e) {
        console.error('soft delete by id failed', e);
      }
    }

    function updatePlayer(id, field, value) {
      if (!USE_FIREBASE) {
        const player = players.find(p => p.id === id);
        if (player) {
          if (field === 'max') {
            const v = Math.max(1, Number(value)||1);
            player.max = v;
            if (player.hp > v) player.hp = v;
          } else if (field === 'name') {
            player.name = value;
          } else if (field === 'color') {
            player.color = value;
          } else if (field === 'hp') {
            const v = Math.max(0, Math.min(player.max, Number(value)||0));
            player.hp = v;
          }
          render();
        }
        return;
      }
      const patch = { updatedAt: firebase.firestore.FieldValue.serverTimestamp() };
      if (field === 'max') patch.max = Math.max(1, Number(value) || 1);
      else if (field === 'name' || field === 'color') patch[field] = value;
      else if (field === 'hp') patch.hp = Math.max(0, Number(value) || 0);
      playersCol.doc(String(id)).set(patch, { merge: true });
    }

    const debounceMap = new Map();
    function changeHP(id, delta) {
      if (!USE_FIREBASE) {
        const player = players.find(p => p.id === id);
        if (player) {
          player.hp = Math.max(0, Math.min(player.max, player.hp + delta));
          render();
          flashPlayer(id, delta > 0 ? 'up' : 'down');
        }
        return;
      }
      clearTimeout(debounceMap.get(id));
      const t = setTimeout(async () => {
        const snap = await playersCol.doc(String(id)).get();
        const p = snap.data(); if (!p) return;
        const next = Math.max(0, Math.min(p.max, (p.hp || 0) + delta));
        playersCol.doc(String(id)).set({ hp: next, updatedAt: firebase.firestore.FieldValue.serverTimestamp() }, { merge: true });
      }, 110);
      debounceMap.set(id, t);
    }
    function setHP(id, value) {
      if (!USE_FIREBASE) {
        const player = players.find(p => p.id === id);
        if (player) {
          const oldHP = player.hp;
          player.hp = Math.max(0, Math.min(player.max, Number(value)||0));
          render();
          if (player.hp !== oldHP) flashPlayer(id, player.hp > oldHP ? 'up' : 'down');
        }
        return;
      }
      playersCol.doc(String(id)).get().then(s => {
        const max = Math.max(1, (s.data()?.max ?? 1));
        const clamped = Math.max(0, Math.min(max, Number(value) || 0));
        return playersCol.doc(String(id)).set({ hp: clamped, updatedAt: firebase.firestore.FieldValue.serverTimestamp() }, { merge: true });
      });
    }
    function sortPlayers(mode) { sortMode = mode; document.querySelectorAll('.btn-sort').forEach(b=>b.classList.remove('active')); if (mode!=='none') document.getElementById(`sort-${mode}`).classList.add('active'); render(); }

    function getHealthColor(percent) {
      if (percent > 50) return 'linear-gradient(90deg, #10b981, #22c55e)';
      else if (percent > 25) return 'linear-gradient(90deg, #eab308, #facc15)';
      else if (percent > 10) return 'linear-gradient(90deg, #f97316, #fb923c)';
      else return 'linear-gradient(90deg, #dc2626, #ef4444)';
    }
    function getTextColor(percent) {
      if (percent > 50) return '#004d26';
      else if (percent > 25) return '#713f12';
      else if (percent > 10) return '#7c2d12';
      else return '#450a0a';
    }
    function getSortedPlayers() {
      const sorted = [...players];
      if (sortMode === 'name') sorted.sort((a, b) => a.name.localeCompare(b.name));
      else if (sortMode === 'hpdesc') sorted.sort((a, b) => b.hp - a.hp);
      else if (sortMode === 'hpasc') sorted.sort((a, b) => a.hp - b.hp);
      return sorted;
    }

    function toggleFullscreen() {
      const fs = document.getElementById('fullscreen');
      if (fs.classList.contains('active')) {
        fs.classList.remove('active');
        document.exitFullscreen?.();
      } else {
        fs.classList.add('active');
        renderFullscreen();
        document.documentElement.requestFullscreen?.();
      }
    }
    function flashPlayer(id, direction) { document.querySelectorAll(`[data-player-id="${id}"]`).forEach(c => { c.classList.add(direction==='up'?'flash-up':'flash-down'); setTimeout(()=>c.classList.remove('flash-up','flash-down'), 200); }); }

    function renderFullscreen() {
      const content = document.getElementById('fullscreen-content');
      const sorted = getSortedPlayers();
      content.innerHTML = sorted.map(p => {
        const percent = Math.round((p.hp / p.max) * 100);
        const bgColor = p.hp === 0 ? '#4a0000' : '#0f1419';
        const barColor = getHealthColor(percent);
        const textColor = getTextColor(percent);
        const displayHP = p.hp === 0 ? '' : p.hp;
        return `
          <div class="player-display">
            <div class="player-header">
              <div class="player-name-display" style="color: ${p.color}">${p.name}</div>
              <div class="player-percent">${percent}%</div>
            </div>
            <div class="hp-bar-container" style="background-color: ${bgColor}">
              <div class="hp-bar" data-player-id="${p.id}" style="width: ${percent}%; background: ${barColor}; color: ${textColor};">
                ${displayHP}
              </div>
            </div>
          </div>
        `;
      }).join('');
    }

    function render() {
      const sorted = getSortedPlayers();
      const displayArea = document.getElementById('display-area');
      displayArea.innerHTML = sorted.map(p => {
        const percent = Math.round((p.hp / p.max) * 100);
        const bgColor = p.hp === 0 ? '#4a0000' : '#0f1419';
        const barColor = getHealthColor(percent);
        const textColor = getTextColor(percent);
        const displayHP = p.hp === 0 ? '' : p.hp;
        return `
          <div class="player-display">
            <div class="player-header">
              <div class="player-name-display" style="color: ${p.color}">${p.name}</div>
              <div class="player-percent">${percent}%</div>
            </div>
            <div class="hp-bar-container" style="background-color: ${bgColor}">
              <div class="hp-bar" data-player-id="${p.id}" style="width: ${percent}%; background: ${barColor}; color: ${textColor};">
                ${displayHP}
              </div>
            </div>
          </div>
        `;
      }).join('');

      // EDIT: compact header with inline PV/Max
      const edit = document.getElementById('edit-stack');
      edit.innerHTML = players.map(p => {
        const percent = Math.round((p.hp / p.max) * 100);
        const docId = p._docId || String(p.id);
        return `
          <div class="edit-card" data-player-id="${p.id}">
            <div class="edit-header">
              <input class="color-pick" type="color" value="${p.color}" onchange="updatePlayer(${p.id}, 'color', this.value)">
              <input class="edit-name" value="${p.name}" onchange="updatePlayer(${p.id}, 'name', this.value)" /><div class="inline-field">
                <label>Max</label>
                <input type="number" value="${p.max}" min="1" onchange="updatePlayer(${p.id}, 'max', parseInt(this.value))">
              </div>
              <span class="badge">${p.hp}/${p.max}</span>
            </div>

            <div class="edit-body">
              <div class="big-keys">
  <button class="key neg" onclick="setHP(${p.id}, 0)" type="button">‚ò†Ô∏è</button>
  <button class="key neg" onclick="changeHP(${p.id}, -10)" type="button">-10</button>
  <button class="key neg" onclick="changeHP(${p.id}, -5)" type="button">-5</button>
  <button class="key neg" onclick="changeHP(${p.id}, -1)" type="button">-1</button>
  <input class="pv-center" type="number" value="${p.hp}" min="0" max="${p.max}" onchange="setHP(${p.id}, parseInt(this.value)||0)">
  <button class="key pos" onclick="changeHP(${p.id}, 1)" type="button">+1</button>
  <button class="key pos" onclick="changeHP(${p.id}, 5)" type="button">+5</button>
  <button class="key pos" onclick="changeHP(${p.id}, 10)" type="button">+10</button>
  <button class="key pos" onclick="setHP(${p.id}, ${p.max})" type="button">üíö</button>
</div>

              <div style="display:flex; justify-content:flex-end;">
  <button class="danger-btn" type="button" onclick="removePlayer(${p.id}, '${docId}')">üóëÔ∏è Supprimer</button>
</div>
            </div>
          </div>
        `;
      }).join('');

      saveData();

      const fs = document.getElementById('fullscreen');
      if (fs && fs.classList.contains('active')) renderFullscreen();
    }

    document.addEventListener('keydown', (e) => {
      if ((e.key || '').toLowerCase() === 'f') toggleFullscreen();
      if (e.key === 'Escape') { const fs = document.getElementById('fullscreen'); if (fs.classList.contains('active')) toggleFullscreen(); }
    });

    loadData();
    render();
  </script>

  <!-- Firebase (compat) -->
  <script src="https://www.gstatic.com/firebasejs/10.13.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.13.1/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.13.1/firebase-auth-compat.js"></script>
  <script>
    if (window.firebase && true) {
      const firebaseConfig = {
        apiKey: "AIzaSyBRdDQ6SfPrwU1pT-m2DEdL1RuSIRd3uZ8",
        authDomain: "hpbars-4bd0e.firebaseapp.com",
        projectId: "hpbars-4bd0e",
        storageBucket: "hpbars-4bd0e.firebasestorage.app",
        messagingSenderId: "587307780453",
        appId: "1:587307780453:web:49520794cb59c82fe5b98c",
        measurementId: "G-LKE20WLCSZ"
      };
      try { firebase.initializeApp(firebaseConfig); } catch (e) {}
      const auth = firebase.auth();
      const db = firebase.firestore();
      auth.signInAnonymously().catch(console.error);
      db.enablePersistence({ synchronizeTabs: true }).catch((err) => { console.warn('Firestore persistence disabled:', err && err.code); });

      const ROOM_ID = 'AMERTUME_HP';
      window.db = db;
      window.playersCol = db.collection('rooms').doc(ROOM_ID).collection('players');

      playersCol.orderBy('id').onSnapshot((snap) => {
        players = snap.docs
          .map(d => ({ ...d.data(), _docId: d.id }))
          .filter(p => !p.__deleted);
        nextId = players.length ? Math.max(...players.map(p => p.id)) + 1 : 1;
        render();
      });
    }
  </script>

  <script>
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => { navigator.serviceWorker.register('./sw.js').catch(console.error); });
    }
  </script>

<script>
(function(){
  // Debounce helper
  let rafId = null;
  const schedule = (fn) => {
    if (rafId) cancelAnimationFrame(rafId);
    rafId = requestAnimationFrame(fn);
  };

  function findMaxInput(card){
    const inputs = Array.from(card.querySelectorAll('input[type="number"]'));
    for (const inp of inputs){
      const name = ((inp.name||'') + ' ' + (inp.id||'') + ' ' + (inp.getAttribute('aria-label')||'')).toLowerCase();
      const prev = ((inp.previousElementSibling && inp.previousElementSibling.textContent) || '');
      const label = ((inp.closest('label') && inp.closest('label').textContent) || '');
      if (/\bmax\b/.test(name) || /\bmax\b/i.test(prev) || /\bmax\b/i.test(label)) return inp;
    }
    return null;
  }

  function placeButton(card){
    const btn = card.querySelector('.danger-btn');
    if(!btn) return false;

    // Emoji-only + a11y
    btn.textContent = 'üóëÔ∏è';
    btn.setAttribute('aria-label','Supprimer');
    btn.title = 'Supprimer';
    btn.style.position = 'static';

    const maxInput = findMaxInput(card);
    if(!maxInput) return false;

    // find the "capsule" around max input
    let capsule = maxInput.closest('label') || maxInput.parentElement;
    if (!capsule || capsule.classList.contains('inline-max-with-delete')) return false;

    // Ensure we don't duplicate wrappers. Remove old inline wrapper if it exists and is empty.
    const existingWrapper = capsule.parentElement && capsule.parentElement.classList && capsule.parentElement.classList.contains('inline-max-with-delete') ? capsule.parentElement : null;
    if (existingWrapper && existingWrapper.querySelector('.danger-btn')) {
      // already good
      return true;
    }

    const wrapper = existingWrapper || document.createElement('span');
    if (!existingWrapper) {
      wrapper.className = 'inline-max-with-delete';
      wrapper.style.display = 'inline-flex';
      wrapper.style.alignItems = 'center';
      wrapper.style.gap = '8px';
      capsule.parentElement.insertBefore(wrapper, capsule);
      wrapper.appendChild(capsule);
    }
    wrapper.appendChild(btn);
    return true;
  }

  function applyAll(){
    document.querySelectorAll('.edit-card').forEach(placeButton);
  }

  const boot = () => schedule(applyAll);

  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', boot);
  } else {
    boot();
  }

  // Observe mutations on the root container to re-apply when cards update
  const root = document.body;
  const mo = new MutationObserver(() => schedule(applyAll));
  mo.observe(root, { childList: true, subtree: true });

  // Also hook common render triggers
  document.addEventListener('click', (e)=>{
    const t = e.target;
    if (!t) return;
    if (t.matches('[data-tab], [data-view], .btn, button')) schedule(applyAll);
  });

  // Expose a global re-align if the app calls render functions we can patch
  window.__alignDeleteNextToMax = applyAll;
})();
</script>


<!-- removed old flash-on-card script -->


<script>
// UI 6.6: flash feedback on +/- buttons (button only)
(function(){
  const flashBtn = (btn, cls, dur=300) => {
    if(!btn) return;
    btn.classList.remove(cls);
    void btn.offsetWidth; // reflow to replay animation
    btn.classList.add(cls);
    setTimeout(()=> btn.classList.remove(cls), dur);
  };

  document.addEventListener('click', function(e){
    const btn = e.target.closest('button.key, .key button, .key'); // try to catch the visual key
    // If not a key, bail early.
    if (!btn || !(btn.classList && btn.classList.contains('key'))) return;

    const txt = (btn.textContent || "").trim();
    const isNeg = btn.classList.contains('neg') || /^-\d+/.test(txt) || txt.includes('‚ò†');
    const isPos = btn.classList.contains('pos') || /^\+\d+/.test(txt) || txt.includes('üíö');

    if (isNeg) return flashBtn(btn, 'btn-flash-neg');
    if (isPos) return flashBtn(btn, 'btn-flash-pos');
  }, true);
})();
</script>


<script>
// UI 6.7: Toggle 'dead' style on hp bars when width is 0%
(function(){
  function updateDeadStates(root=document){
    document.querySelectorAll('.hp-bar').forEach(el=>{
      const cont = el.closest('.hp-bar-container');
      if(!cont) return;

      // read inline width percentage if present
      let w = 0;
      const styleWidth = (el.getAttribute('style')||'').match(/width:\s*([0-9.]+)%/);
      if (styleWidth) w = parseFloat(styleWidth[1]);

      // Fallback: computed width
      if (!styleWidth){
        const cw = el.getBoundingClientRect().width;
        w = cw < 2 ? 0 : 1; // treat ultra thin as zero
      }

      if (w <= 0) cont.classList.add('dead');
      else cont.classList.remove('dead');
    });
  }

  // Run at load and on DOM changes
  const boot = () => requestAnimationFrame(updateDeadStates);
  if (document.readyState === 'loading') document.addEventListener('DOMContentLoaded', boot);
  else boot();

  const mo = new MutationObserver(()=> requestAnimationFrame(updateDeadStates));
  mo.observe(document.body, {childList:true, subtree:true, attributes:true, attributeFilter:['style']});

  // Also re-check when window resizes (rarely needed but safe)
  window.addEventListener('resize', ()=> requestAnimationFrame(updateDeadStates));

  // Expose manual hook
  window.__refreshHpDeadStates = updateDeadStates;
})();
</script>

</body>
</html>
